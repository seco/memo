* DB를 읽는 클래스(DAO or Repository)

* 다오를 가지는 서비스 객체(메소드, 트랜젝션 단위로 동작. 하나의 서비스는 여러개의 다오를 가질 수 있다.)

  * 트랜젝션 처리를 위햏서는 Platform Transaction Manager가 필요하다.

  * 두 개의 에노테이션이 있다. (@Transactional, @transactional(readOnly=true))

  * 플랫폼 트랜젝션 매니저는 데이터 소스(인터페이스)를 사용함.

  * 데이터 소스를 구현하는 객체는 DBCP, HikariCP가 있다.(유명한 두 개의 객체)

  * 데이터 소스는 Connection(인터페이스)을 사용한다.(의존한다. 점선)

  * 트랜젝션 하나의 논리적인 작업 단위. 

  * AOP 자동으로 어떤 기능이 적용되도록 끼워넣는 것. 횡단 관심이라고 했다.

  * Runtime Exception이 발생하면 Rollback을 한다. 

  * AOP적용은 트렌젝션이 시작할 때 begin, commit, rollback(Connection이 가지고 있다.)

  * 서비스에 있는 트렌젝션을 처리해주는 메소드(비즈니스 메소드, 비즈니스 객체)가 뭐가 있는지 알아야한다.

  * 분석을 한다고 하면 비즈니스 메소드를 만드는 것이 중요합니다.

  * 게시판에서 게시물 조회 기능을 보면 게시물 증가와 게시물 조회 기능이 하나로 묶여야한다. 비즈니스 메소드라고 한다. 프로그램을 짤 때 비즈니스 메소드를 고민해야한다.

* 서비스를 가지는 컨트롤러 객체(UI를 처리하는 메소드)



설정을 관리해주는 파일들이 따로 있다. 



데이터 소스는 인터페이스이고 해당 인터페이스를 구현하는 객체가 필요하다.

DBCP, HirariCP

또 다른 말로는 커넥션 풀을 사용하기 위한 인터페이스이다.

커텍션풀은 커넥션들을 미리 연결해서 가지고 있는 객체.

왜 미리 커텍션을 연결해놓느냐? 이 커넥션을 연결할때 비용이 발생한다.

DB에서 데이터를 가지고 올때 데이터를 가지고 오는 것보다 연결할 때 더 많은 비용이 발생하기 때문에 연결을 최소화해야한다. 

Connection을 빌려와서 사용하고 돌려준다. DataSource로부터 Connection을 얻은 후, 해당 Connection을 close()하면 되돌려준다.

커넥션을 빨리 되돌려주려면?

1) slow sql을 제거한다.

2) 과도하게 많은 sql이 사용되면 안된다. (비즈니스 메소드를 최소화한다.)

3) DB에는 과도한 커넥션을 연결할 수 없다. 적절히 조절해야한다. DBA에게 물어봐야 한다.

4) 스터디 주제 : 커넥션 풀에 어떤 설정을 할 수 에씨는지 공부.

-------------------------------------------------------------

커넥션 풀을 설정할 때 해야할 것? : 갯수 설정. 커넥션이 부족할 때 자동으로 늘려주고 줄여야한다. 그렇지만 현업에서는 늘렸다 줄였다하는 것은 바람직하지 않다. 초기값, 최소값, 최대값을 똑같이 한다. 오버헤드가 발생하기 때문. DB를 알아야한다. 

게시판에서 보면 한 페이지에 100개의 개시물을 보여준다고 하면, 반복문에서 보여줄텐데. 



@EnableTransactionManagement : AOP를 적용해주는 것.

트랜젝션 처리를 하려면 DataSource, PlatformTransactionManager를 구현하는 Bean을 선언한다.

Java Config에 @EnableTransactionManagement를 붙여주면 AOP가 적용된 트렌젝션이 완성되는 것.





-----

daoexam 프로젝트 JDBC 접속.

```mysql
create table board( id bigint(20) unsigned not null auto_increment,
    -> title varchar(255) not null,
    -> name varchar(255) not null,
    -> content text,
    -> regdate datetime,
    -> read_count int,
    -> primary key(id));

```



sample data 넣기.

```mysql
insert into board(title, name, content, regdate, read_count) values ();
insert into member(name, email, password, regdate) values ('kim', 'a@a.com', 123, now());
```



Spring JDBC를 이용해서 DAO를 만든다. 

Spring JDBC에서 가장 핵심은 JdbcTemplate

JdbcTemplate을 조금 더 편하게 사용할 수 있도록 하는 클래스는 NamedParameterJdbcTemplate

-JDBC의 지루한 코드를 줄여주는 기능을 가지고 있다. 

// insert, update, delete, select

-사용자는 SQL을 작성하고, 해당 SQL에 바인딩할 객체(보통 Map)를 설정한다.

//select

-select한 결과를 DTO에 담아주는 기능을 가지고 있다. - Mapper

-NamedParameterJdbcTemplate은 ? 대신에 이름을 사용할 수 있도록 한다.



Dao 만드는 방법

- @Repository 에노테이션을 붙인다.
- 필드로 JdbcTemplate, SimpleJdbcInsert가 선언된다.
- 생성자에서 DataSource를 주입받아서 JdbcTemplate을 초기화한다.
- 경우에 따라서는 insert를 편하게 하려고 SimpleJdbcInsert를 초기화한다.

```java

    public BoardDao(DataSource dataSource){
        this.jdbc = new NamedParameterJdbcTemplate(dataSource);

        this.insertAction = new SimpleJdbcInsert(dataSource)
                .withTableName("board")
                .usingGeneratedKeyColumns("id"); //자동으로 생성되는 칼럼이 있는 경우
    }
```



SimpleJdbcInsert는 insert SQL 문장을 내부적으로 자동으로만든다.

insert into board values(?, ?, ...);

이 문장에 값을 자동으로 채워넣어야한다.

?에 채울 값은 SqlParameterSource, Map 형태로 만든다.

스프링 JDBC를 이용하는 것이니 사용법만 익히면 된다. 



BoardDao를 사용해보자.

입력, 조회 



---

NamedParameterJdbcTemplate

- insert, update, delete를 하려면? update(SQL, 바인딩할객체)
- 1건 or null을 select하려면 queryForObjet(SQL, 바인딩할객체, Mapper)
- 0건 이상의 List로 



---

조별 토론

회원정보를 저장하는 테이블을 만든다.

id(자동생성)

name

email

password

regdate(등록일)



최소한 위의 칼럼은 있어야한다.

위의 테이블에서 저장, email에 해당하는 회원정보 조회를 만들려면 어떻게 할까?

dao, service



어떤 클래스를 만들어봐야한다. 







* 오늘 할 일
  * 맛집찾기(내일회식)
  * 교수님 전화
  * 인텔리제이 연장
  * 자바 책 읽기
  * 오늘 수업 정리 > 오늘꺼 정리 후 저번주 수업 정리. 
  * 자료구조&알고리즘
  * 조바꿈?
  * 의존관계, 가지는 관계

